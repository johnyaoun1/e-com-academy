<div class="checkout-page">
  <div class="container">
    <h1>Checkout</h1>

    <div class="checkout-content">
      <div class="checkout-form">
        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
            <span class="step-number">1</span>
            <span class="step-label">Shipping</span>
          </div>
          <div class="step-line" [class.active]="currentStep > 1"></div>
          <div class="step" [class.active]="currentStep >= 2">
            <span class="step-number">2</span>
            <span class="step-label">Payment</span>
          </div>
        </div>

        <form [formGroup]="checkoutForm">
          <!-- Shipping Step -->
          <div *ngIf="currentStep === 1" formGroupName="shipping" class="form-step">
            <h2>Shipping Information</h2>
            
            <div class="form-row">
              <div class="form-group">
                <label>First Name *</label>
                <input type="text" formControlName="firstName" class="form-control"
                       [class.is-invalid]="checkoutForm.get('shipping.firstName')?.invalid && checkoutForm.get('shipping.firstName')?.touched">
                <div *ngIf="checkoutForm.get('shipping.firstName')?.invalid && checkoutForm.get('shipping.firstName')?.touched"
                     class="invalid-feedback">
                  Please enter your first name
                </div>
              </div>
              <div class="form-group">
                <label>Last Name *</label>
                <input type="text" formControlName="lastName" class="form-control"
                       [class.is-invalid]="checkoutForm.get('shipping.lastName')?.invalid && checkoutForm.get('shipping.lastName')?.touched">
                <div *ngIf="checkoutForm.get('shipping.lastName')?.invalid && checkoutForm.get('shipping.lastName')?.touched"
                     class="invalid-feedback">
                  Please enter your last name
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Email *</label>
              <input type="email" formControlName="email" class="form-control"
                     [class.is-invalid]="checkoutForm.get('shipping.email')?.invalid && checkoutForm.get('shipping.email')?.touched">
              <div *ngIf="checkoutForm.get('shipping.email')?.errors?.['required'] && checkoutForm.get('shipping.email')?.touched"
                   class="invalid-feedback">
                Please enter your email
              </div>
              <div *ngIf="checkoutForm.get('shipping.email')?.errors?.['email'] && checkoutForm.get('shipping.email')?.touched"
                   class="invalid-feedback">
                Please enter a valid email
              </div>
            </div>

            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" formControlName="phone" class="form-control"
                     [class.is-invalid]="checkoutForm.get('shipping.phone')?.invalid && checkoutForm.get('shipping.phone')?.touched">
              <div *ngIf="checkoutForm.get('shipping.phone')?.invalid && checkoutForm.get('shipping.phone')?.touched"
                   class="invalid-feedback">
                Please enter your phone number
              </div>
            </div>

            <div class="form-group">
              <label>Address *</label>
              <input type="text" formControlName="address" class="form-control"
                     [class.is-invalid]="checkoutForm.get('shipping.address')?.invalid && checkoutForm.get('shipping.address')?.touched">
              <div *ngIf="checkoutForm.get('shipping.address')?.invalid && checkoutForm.get('shipping.address')?.touched"
                   class="invalid-feedback">
                Please enter your address
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>City *</label>
                <input type="text" formControlName="city" class="form-control"
                       [class.is-invalid]="checkoutForm.get('shipping.city')?.invalid && checkoutForm.get('shipping.city')?.touched">
                <div *ngIf="checkoutForm.get('shipping.city')?.invalid && checkoutForm.get('shipping.city')?.touched"
                     class="invalid-feedback">
                  Please enter your city
                </div>
              </div>
              <div class="form-group">
                <label>State *</label>
                <input type="text" formControlName="state" class="form-control"
                       [class.is-invalid]="checkoutForm.get('shipping.state')?.invalid && checkoutForm.get('shipping.state')?.touched">
                <div *ngIf="checkoutForm.get('shipping.state')?.invalid && checkoutForm.get('shipping.state')?.touched"
                     class="invalid-feedback">
                  Please enter your state
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Zip Code *</label>
                <input type="text" formControlName="zipCode" class="form-control"
                       [class.is-invalid]="checkoutForm.get('shipping.zipCode')?.invalid && checkoutForm.get('shipping.zipCode')?.touched">
                <div *ngIf="checkoutForm.get('shipping.zipCode')?.invalid && checkoutForm.get('shipping.zipCode')?.touched"
                     class="invalid-feedback">
                  Please enter your zip code
                </div>
              </div>
              <div class="form-group">
                <label>Country *</label>
                <select formControlName="country" class="form-control"
                        [class.is-invalid]="checkoutForm.get('shipping.country')?.invalid && checkoutForm.get('shipping.country')?.touched">
                  <option value="">Select Country</option>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <option value="UK">United Kingdom</option>
                </select>
                <div *ngIf="checkoutForm.get('shipping.country')?.invalid && checkoutForm.get('shipping.country')?.touched"
                     class="invalid-feedback">
                  Please select your country
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" routerLink="/cart">
                Back to Cart
              </button>
              <button type="button" class="btn-primary" (click)="nextStep()"
                      [disabled]="checkoutForm.get('shipping')?.invalid">
                Continue to Payment
              </button>
            </div>
          </div>

          <!-- Payment Step -->
          <div *ngIf="currentStep === 2" formGroupName="payment" class="form-step">
            <h2>Payment Information</h2>

            <div class="payment-demo-notice">
              <h3>DEMO PAYMENT</h3>
              <p>Use these test card details:</p>
              <ul>
                <li>Card: <code>4242 4242 4242 4242</code></li>
                <li>Date: Any future date (MM/YY)</li>
                <li>CVC: Any 3 digits</li>
              </ul>
            </div>

            <div class="form-group">
              <label>Card Number *</label>
              <input type="text" formControlName="cardNumber" class="form-control" 
                     placeholder="1234 5678 9012 3456"
                     [class.is-invalid]="checkoutForm.get('payment.cardNumber')?.invalid && checkoutForm.get('payment.cardNumber')?.touched">
              <div *ngIf="checkoutForm.get('payment.cardNumber')?.errors?.['required'] && checkoutForm.get('payment.cardNumber')?.touched"
                   class="invalid-feedback">
                Please enter your card number
              </div>
              <div *ngIf="checkoutForm.get('payment.cardNumber')?.errors?.['pattern'] && checkoutForm.get('payment.cardNumber')?.touched"
                   class="invalid-feedback">
                Please enter a valid 16-digit card number
              </div>
            </div>

            <div class="form-group">
              <label>Name on Card *</label>
              <input type="text" formControlName="cardName" class="form-control"
                     [class.is-invalid]="checkoutForm.get('payment.cardName')?.invalid && checkoutForm.get('payment.cardName')?.touched">
              <div *ngIf="checkoutForm.get('payment.cardName')?.invalid && checkoutForm.get('payment.cardName')?.touched"
                   class="invalid-feedback">
                Please enter the name on your card
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Expiry Date *</label>
                <input type="text" formControlName="expiryDate" class="form-control" 
                       placeholder="MM/YY"
                       [class.is-invalid]="checkoutForm.get('payment.expiryDate')?.invalid && checkoutForm.get('payment.expiryDate')?.touched">
                <div *ngIf="checkoutForm.get('payment.expiryDate')?.errors?.['required'] && checkoutForm.get('payment.expiryDate')?.touched"
                     class="invalid-feedback">
                  Please enter expiry date
                </div>
                <div *ngIf="checkoutForm.get('payment.expiryDate')?.errors?.['pattern'] && checkoutForm.get('payment.expiryDate')?.touched"
                     class="invalid-feedback">
                  Please use MM/YY format
                </div>
              </div>
              <div class="form-group">
                <label>CVV *</label>
                <input type="text" formControlName="cvv" class="form-control" 
                       placeholder="123"
                       [class.is-invalid]="checkoutForm.get('payment.cvv')?.invalid && checkoutForm.get('payment.cvv')?.touched">
                <div *ngIf="checkoutForm.get('payment.cvv')?.errors?.['required'] && checkoutForm.get('payment.cvv')?.touched"
                     class="invalid-feedback">
                  Please enter CVV
                </div>
                <div *ngIf="checkoutForm.get('payment.cvv')?.errors?.['pattern'] && checkoutForm.get('payment.cvv')?.touched"
                     class="invalid-feedback">
                  Please enter 3 or 4 digit code
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="previousStep()">
                Back
              </button>
              <button type="button" class="btn-primary" (click)="placeOrder()"
                      [disabled]="checkoutForm.invalid">
                Place Order
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>
        
        <div class="order-items">
          <div class="order-item" *ngFor="let item of cartItems$ | async">
            <img [src]="item.product.image" [alt]="item.product.title">
            <div class="item-info">
              <p class="item-title">{{ item.product.title | truncate:50 }}</p>
              <p class="item-quantity">Qty: {{ item.quantity }}</p>
            </div>
            <p class="item-price">{{ (item.product.price * item.quantity) | currency }}</p>
          </div>
        </div>

        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span>{{ cartTotal | currency }}</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span>Free</span>
          </div>
          <div class="summary-row">
            <span>Tax</span>
            <span>{{ (cartTotal * 0.08) | currency }}</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span>{{ (cartTotal * 1.08) | currency }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>