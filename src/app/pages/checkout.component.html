<div class="checkout-page">
  <div class="container">
    <h1>Checkout</h1>

    <div class="checkout-content">
      <div class="checkout-form">
        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
            <span class="step-number">1</span>
            <span class="step-label">Shipping</span>
          </div>
          <div class="step-line" [class.active]="currentStep > 1"></div>
          <div class="step" [class.active]="currentStep >= 2">
            <span class="step-number">2</span>
            <span class="step-label">Payment</span>
          </div>
        </div>

        <form [formGroup]="checkoutForm">
          <!-- Shipping Step -->
          <div *ngIf="currentStep === 1" formGroupName="shipping" class="form-step">
            <h2>Shipping Information</h2>
            
            <div class="form-row">
              <div class="form-group">
                <label>First Name *</label>
                <input type="text" formControlName="firstName" class="form-control"
                       [class.is-invalid]="isFieldInvalid('shipping.firstName')">
                <div *ngIf="isFieldInvalid('shipping.firstName')" class="invalid-feedback">
                  {{ getFieldError('shipping.firstName') }}
                </div>
              </div>
              <div class="form-group">
                <label>Last Name *</label>
                <input type="text" formControlName="lastName" class="form-control"
                       [class.is-invalid]="isFieldInvalid('shipping.lastName')">
                <div *ngIf="isFieldInvalid('shipping.lastName')" class="invalid-feedback">
                  {{ getFieldError('shipping.lastName') }}
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Email *</label>
              <input type="email" formControlName="email" class="form-control"
                     [class.is-invalid]="isFieldInvalid('shipping.email')">
              <div *ngIf="isFieldInvalid('shipping.email')" class="invalid-feedback">
                {{ getFieldError('shipping.email') }}
              </div>
            </div>

            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" formControlName="phone" class="form-control"
                     [class.is-invalid]="isFieldInvalid('shipping.phone')">
              <div *ngIf="isFieldInvalid('shipping.phone')" class="invalid-feedback">
                {{ getFieldError('shipping.phone') }}
              </div>
            </div>

            <div class="form-group">
              <label>Address *</label>
              <input type="text" formControlName="address" class="form-control"
                     [class.is-invalid]="isFieldInvalid('shipping.address')">
              <div *ngIf="isFieldInvalid('shipping.address')" class="invalid-feedback">
                {{ getFieldError('shipping.address') }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>City *</label>
                <input type="text" formControlName="city" class="form-control"
                       [class.is-invalid]="isFieldInvalid('shipping.city')">
                <div *ngIf="isFieldInvalid('shipping.city')" class="invalid-feedback">
                  {{ getFieldError('shipping.city') }}
                </div>
              </div>
              <div class="form-group">
                <label>State *</label>
                <input type="text" formControlName="state" class="form-control"
                       [class.is-invalid]="isFieldInvalid('shipping.state')">
                <div *ngIf="isFieldInvalid('shipping.state')" class="invalid-feedback">
                  {{ getFieldError('shipping.state') }}
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Zip Code *</label>
                <input type="text" formControlName="zipCode" class="form-control"
                       [class.is-invalid]="isFieldInvalid('shipping.zipCode')">
                <div *ngIf="isFieldInvalid('shipping.zipCode')" class="invalid-feedback">
                  {{ getFieldError('shipping.zipCode') }}
                </div>
              </div>
              <div class="form-group">
                <label>Country *</label>
                <select formControlName="country" class="form-control"
                        [class.is-invalid]="isFieldInvalid('shipping.country')">
                  <option value="">Select Country</option>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <option value="UK">United Kingdom</option>
                </select>
                <div *ngIf="isFieldInvalid('shipping.country')" class="invalid-feedback">
                  {{ getFieldError('shipping.country') }}
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" routerLink="/cart">
                Back to Cart
              </button>
              <button type="button" class="btn-primary" (click)="nextStep()"
                      [disabled]="checkoutForm.get('shipping')?.invalid">
                Continue to Payment
              </button>
            </div>
          </div>

          <!-- Payment Step -->
          <div *ngIf="currentStep === 2" formGroupName="payment" class="form-step">
            <h2>Payment Information</h2>

            <div class="payment-demo-notice">
              <h3>DEMO PAYMENT</h3>
              <p>Use these test card details (pre-filled):</p>
              <ul>
                <li>Card: <code>4242 4242 4242 4242</code></li>
                <li>Date: <code>12/25</code></li>
                <li>CVC: <code>123</code></li>
              </ul>
            </div>

            <div class="form-group">
              <label>Card Number *</label>
              <input type="text" formControlName="cardNumber" class="form-control" 
                     placeholder="1234 5678 9012 3456"
                     [class.is-invalid]="isFieldInvalid('payment.cardNumber')">
              <div *ngIf="isFieldInvalid('payment.cardNumber')" class="invalid-feedback">
                {{ getFieldError('payment.cardNumber') }}
              </div>
            </div>

            <div class="form-group">
              <label>Name on Card *</label>
              <input type="text" formControlName="cardName" class="form-control"
                     [class.is-invalid]="isFieldInvalid('payment.cardName')">
              <div *ngIf="isFieldInvalid('payment.cardName')" class="invalid-feedback">
                {{ getFieldError('payment.cardName') }}
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Expiry Date *</label>
                <input type="text" formControlName="expiryDate" class="form-control" 
                       placeholder="MM/YY"
                       [class.is-invalid]="isFieldInvalid('payment.expiryDate')">
                <div *ngIf="isFieldInvalid('payment.expiryDate')" class="invalid-feedback">
                  {{ getFieldError('payment.expiryDate') }}
                </div>
              </div>
              <div class="form-group">
                <label>CVV *</label>
                <input type="text" formControlName="cvv" class="form-control" 
                       placeholder="123"
                       [class.is-invalid]="isFieldInvalid('payment.cvv')">
                <div *ngIf="isFieldInvalid('payment.cvv')" class="invalid-feedback">
                  {{ getFieldError('payment.cvv') }}
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="previousStep()">
                Back
              </button>
              <button type="button" class="btn-primary" (click)="placeOrder()"
                      [disabled]="!canPlaceOrder()">
                <span *ngIf="isProcessing">
                  <i class="fas fa-spinner fa-spin"></i> Processing...
                </span>
                <span *ngIf="!isProcessing">
                  <i class="fas fa-credit-card"></i> Place Order
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>
        
        <div class="order-items">
          <div class="order-item" *ngFor="let item of cartItems$ | async">
            <img [src]="item.product.image" [alt]="item.product.title">
            <div class="item-info">
              <p class="item-title">{{ item.product.title | slice:0:50 }}...</p>
              <p class="item-quantity">Qty: {{ item.quantity }}</p>
            </div>
            <p class="item-price">{{ (item.product.price * item.quantity) | currency }}</p>
          </div>
        </div>

        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span>{{ cartTotal | currency }}</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span>Free</span>
          </div>
          <div class="summary-row">
            <span>Tax</span>
            <span>{{ (cartTotal * 0.08) | currency }}</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span>{{ (cartTotal * 1.08) | currency }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Processing Overlay -->
<div *ngIf="isProcessing" class="processing-overlay">
  <div class="processing-modal">
    <div class="spinner"></div>
    <h3>Processing Payment...</h3>
    <p>Please wait while we securely process your payment</p>
  </div>
</div>

<!-- Payment Success Modal -->
<div *ngIf="showSuccessModal" class="success-modal-overlay">
  <div class="success-modal">
    <div class="success-header">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2>Payment Successful!</h2>
      <button class="close-btn" (click)="closeSuccessModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="success-content" *ngIf="orderDetails">
      <div class="order-summary-success">
        <h3>Order Confirmation</h3>
        <div class="order-details">
          <div class="detail-row">
            <span class="label">Order Number:</span>
            <span class="value">#{{ orderDetails.orderId }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Customer:</span>
            <span class="value">{{ orderDetails.customerName }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Email:</span>
            <span class="value">{{ orderDetails.email }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Items:</span>
            <span class="value">{{ orderDetails.itemCount }} items</span>
          </div>
          <div class="detail-row">
            <span class="label">Payment Method:</span>
            <span class="value">{{ orderDetails.paymentMethod.cardType }} ending in {{ orderDetails.paymentMethod.cardLast4 }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Estimated Delivery:</span>
            <span class="value">{{ orderDetails.estimatedDelivery }}</span>
          </div>
          <div class="total-section">
            <div class="detail-row">
              <span class="label">Subtotal:</span>
              <span class="value">{{ orderDetails.subtotal | currency }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Tax:</span>
              <span class="value">{{ orderDetails.tax | currency }}</span>
            </div>
            <div class="detail-row total-amount">
              <span class="label">Total:</span>
              <span class="value">{{ orderDetails.total | currency }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="success-message">
        <div class="message-item">
          <i class="fas fa-check-circle"></i>
          <span>Your order has been placed successfully!</span>
        </div>
        <div class="message-item">
          <i class="fas fa-envelope"></i>
          <span>Confirmation email sent to {{ orderDetails.email }}</span>
        </div>
        <div class="message-item">
          <i class="fas fa-truck"></i>
          <span>Track your order in your profile</span>
        </div>
      </div>
    </div>

    <div class="success-actions">
      <button class="btn-primary" (click)="viewOrderDetails()">
        <i class="fas fa-receipt"></i> View Order Details
      </button>
      <button class="btn-secondary" (click)="continueShopping()">
        <i class="fas fa-shopping-bag"></i> Continue Shopping
      </button>
    </div>
  </div>
</div>